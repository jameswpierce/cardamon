<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>{{ title }}</title>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                let queue = new Map();
                let queueIds = [];
                let queueIndex = 0;
                let isPlaying = false;
                const artists = document.getElementById("artists");
                const albums = document.getElementById("albums");
                const albumOptions = albums.querySelectorAll("option");
                const tracks = document.getElementById("tracks");
                const trackOptions = tracks.querySelectorAll("option");
                const audio = document.getElementById("audio");
                const playButton = document.getElementById("play");
                const nextButton = document.getElementById("next");
                const prevButton = document.getElementById("prev");

                const updateQueueByDataset = ({ key, value }) => {
                    queue.clear();
                    queueIds = [];
                    queueIndex = 0;
                    trackOptions.forEach((trackOption) => {
                        if (trackOption.dataset[key] === value) {
                            const { id } = trackOption;
                            const { number, filePath, artistId, albumId } =
                                trackOption.dataset;
                            queue.set(id, {
                                number,
                                filePath,
                                artistId,
                                albumId,
                            });
                            queueIds.push(id);
                        }
                    });
                    audio.src = queue.get(queueIds[queueIndex]).filePath;
                };

                const updateQueue = (trackOptions) => {
                    queue.clear();
                    queueIds = [];
                    queueIndex = 0;
                    for (trackOption of trackOptions) {
                        const { id } = trackOption;
                        const { number, filePath, artistId, albumId } =
                            trackOption.dataset;
                        queue.set(id, {
                            number,
                            filePath,
                            artistId,
                            albumId,
                        });
                        queueIds.push(id);
                    }
                    audio.src = queue.get(queueIds[queueIndex]).filePath;
                };

                const showHide = (elements, { key, value }) => {
                    elements.forEach((element) => {
                        if (element.dataset[key] === value) {
                            element.style.display = "block";
                            return;
                        }
                        if (element.style.display == "none") {
                            return;
                        }
                        element.style.display = "none";
                    });
                };

                const prev = () => {
                    if (queueIndex > 0) {
                        queueIndex -= 1;
                    }
                    audio.src = queue.get(queueIds[queueIndex]).filePath;
                    play();
                };
                const next = () => {
                    if (queueIndex <= queueIds.length) {
                        queueIndex += 1;
                    }
                    audio.src = queue.get(queueIds[queueIndex]).filePath;
                    play();
                };
                const play = () => {
                    isPlaying = true;
                    audio.play();
                };
                const pause = () => {
                    isPlaying = false;
                    audio.pause();
                };

                artists.addEventListener("click", () => {
                    const artistId = event.target.id;
                    showHide(albumOptions, {
                        key: "artistId",
                        value: artistId,
                    });
                    showHide(trackOptions, {
                        key: "artistId",
                        value: artistId,
                    });
                });
                artists.addEventListener("dblclick", (event) => {
                    const artistId = event.target.id;
                    updateQueueByDataset({ key: "artistId", value: artistId });
                    play();
                });
                albums.addEventListener("click", (event) => {
                    const albumId = event.target.id;
                    showHide(trackOptions, {
                        key: "albumId",
                        value: albumId,
                    });
                });
                albums.addEventListener("dblclick", (event) => {
                    const albumId = event.target.id;
                    updateQueueByDataset({ key: "albumId", value: albumId });
                    play();
                });
                tracks.addEventListener("dblclick", (event) => {
                    updateQueue(event.target.parentElement.selectedOptions);
                    play();
                });
                nextButton.addEventListener("click", () => {
                    next();
                });
                audio.addEventListener("ended", () => {
                    next();
                });
                navigator.mediaSession.setActionHandler("nexttrack", () => {
                    next();
                });
                prevButton.addEventListener("click", () => {
                    prev();
                });
                playButton.addEventListener("click", () => {
                    isPlaying ? pause() : play();
                });
            });
        </script>
        <style>
            * {
                box-sizing: border-box;
                border: 0;
                padding: 0;
                margin: 0;
                font-family: monospace;
            }
            html {
                font-size: 16px;
            }
            select {
                background-color: lime;
                scrollbar-width: none; /*For Firefox*/
                -ms-overflow-style: none; /*For Internet Explorer 10+*/
            }
            select::-webkit-scrollbar {
                /*For WebKit Browsers*/
                width: 0;
            }
            option, button {
                cursor: pointer;
            }
            {%- for i in range(1, 36) -%}
            .bg-color-{{ i }} {
                background-color: hsl({{ (i - 1) * 10}}, 100%, 80%);
            }
            .bg-color-{{ i }}:active {
                background-color: hsl({{ (((i - 1) * 10) + 180) % 360 }}, 100%, 80%);
            }
            .bg-color-{{ i }}:hover {
                background-color: hsl({{ (((i - 1) * 10) + 180) % 360 }}, 100%, 80%);
            }
            {%- endfor -%}
            .flex {
                display: flex;
            }
            .flex-col {
                flex-direction: column;
            }
            .w-full {
                width: 100%;
            }
            .bg-blue {
                background-color: blue;
            }
        </style>
    </head>
    <body>
        <main class="flex flex-col">
            <section
                id="top"
                class="flex"
                style="max-height: calc(40vh - 4rem); height: calc(40vh - 4rem)"
            >
                <select
                    id="artists"
                    class="w-full"
                    style="height: calc(40vh - 4rem)"
                    multiple
                >
                    {%- for (id, artist) in data.artists|items -%}
                    <option
                        id="{{ artist.id }}"
                        class="bg-color-{{ (loop.index % 36) + 1 }}"
                    >
                        {{ artist.name }}
                    </option>
                    {%- endfor -%}
                </select>
                <select
                    id="albums"
                    class="w-full"
                    style="height: calc(40vh - 4rem)"
                    multiple
                >
                    {% for (id, artist) in data.artists|items %} {% for (id,
                    album) in artist.albums|items %}
                    <option
                        id="{{ album.id }}"
                        data-artist-id="{{ album.artist_id }}"
                        class="bg-color-{{ (loop.index % 36) + 1 }}"
                    >
                        {{ album.title }}
                    </option>
                    {% endfor %} {% endfor %}
                </select>
            </section>
            <section id="bottom" style="max-height: calc(60vh - 4rem)">
                <select
                    id="tracks"
                    class="w-full"
                    style="height: calc(60vh - 4rem)"
                    multiple
                >
                    {% for (id, artist) in data.artists|items %} {% for (id,
                    album) in artist.albums|items %} {% for track in
                    album.tracks %}
                    <option
                        id="{{ track.id }}"
                        class="bg-color-{{ (loop.index % 36) + 1 }}"
                        data-number="{{ track.number }}"
                        data-file-path="/music/{{ track.file_path }}"
                        data-artist-id="{{ track.artist_id }}"
                        data-album-id="{{ track.album_id }}"
                    >
                        {{ track.number }} {{ artist.name }} - {{ album.title }}
                        - {{ track.name }}
                    </option>
                    {% endfor %} {% endfor %} {% endfor %}
                </select>
            </section>
        </main>
        <aside class="bg-blue w-full" style="height: 8rem">
            <audio id="audio" controls></audio>
            <span id="now-playing"></span>
            <button id="play">Play</button>
            <button id="prev">Prev</button>
            <button id="next">Next</button>
            <button id="repeat">Repeat</button>
            <button id="shuffle">Shuffle</button>
        </aside>
    </body>
</html>
